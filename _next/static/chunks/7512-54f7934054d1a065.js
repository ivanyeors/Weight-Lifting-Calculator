"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7512],{41152:(e,t,o)=>{o.d(t,{D:()=>m});var a=o(95155),n=o(12115),s=o(30285),c=o(66695),r=o(26126),l=o(69074),i=o(40646),d=o(85339),u=o(53904),h=o(34835),g=o(87519);function m(e){let{onEventsSync:t,onEventCreate:o,onEventUpdate:m,onEventDelete:f}=e,[v,w]=(0,n.useState)(""),[p,x]=(0,n.useState)(!1),{isAuthenticated:A,isLoading:y,error:k,events:T,accounts:E,getAuthUrl:C,handleAuthCallback:S,fetchEvents:b,createEvent:j,updateEvent:N,deleteEvent:F,removeAccount:I,logout:L,convertToGoogleEvent:_,convertFromGoogleEvent:z}=(0,g.R)({autoSync:!0});(0,n.useEffect)(()=>{let e=sessionStorage.getItem("googleCalendarCode"),t=sessionStorage.getItem("googleCalendarState"),o=new URLSearchParams(window.location.search).get("error");if(e&&!A&&(sessionStorage.removeItem("googleCalendarCode"),sessionStorage.removeItem("googleCalendarState"),w(e),D(e,t||void 0).then(()=>{setTimeout(()=>{b()},500)}).catch(e=>{console.error("Authentication failed:",e)})),o){console.error("OAuth error:",o);let e=window.location.pathname+(window.location.hash||"");window.history.replaceState({},document.title,e)}},[A,S]);let D=async(e,t)=>{x(!0);try{await S(e,t),w("")}catch(e){console.error("Authentication failed:",e)}finally{x(!1)}},G=async()=>{try{let e=await b();null==t||t(e.map(z))}catch(e){console.error("Sync failed:",e)}};return(0,a.jsxs)(c.Zp,{className:"w-full max-w-md",children:[(0,a.jsxs)(c.aR,{children:[(0,a.jsxs)(c.ZB,{className:"flex items-center gap-2",children:[(0,a.jsx)(l.A,{className:"w-5 h-5"}),"Google Calendar Sync"]}),(0,a.jsx)(c.BT,{children:"Connect your Google Calendar to sync workout sessions"})]}),(0,a.jsxs)(c.Wu,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm font-medium",children:"Status:"}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:A?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.A,{className:"w-4 h-4 text-green-500"}),(0,a.jsx)(r.E,{variant:"secondary",className:"text-green-700 bg-green-100",children:"Connected"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(d.A,{className:"w-4 h-4 text-orange-500"}),(0,a.jsx)(r.E,{variant:"secondary",className:"text-orange-700 bg-orange-100",children:"Disconnected"})]})})]}),k&&(0,a.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 rounded-md",children:(0,a.jsxs)("div",{className:"flex items-center gap-2 text-red-700",children:[(0,a.jsx)(d.A,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-sm",children:k})]})}),A?(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(s.$,{onClick:G,disabled:y,variant:"outline",className:"w-full",children:y?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.A,{className:"w-4 h-4 mr-2 animate-spin"}),"Syncing..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.A,{className:"w-4 h-4 mr-2"}),"Sync Events"]})}),(0,a.jsxs)(s.$,{onClick:L,variant:"outline",className:"w-full",children:[(0,a.jsx)(h.A,{className:"w-4 h-4 mr-2"}),"Disconnect"]}),(0,a.jsx)("div",{className:"text-xs text-muted-foreground text-center",children:T.length>0?(0,a.jsxs)("span",{children:["Synced ",T.length," events"]}):(0,a.jsx)("span",{children:"No events synced yet"})})]}):(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(s.$,{onClick:()=>{let e=C("/account?tab=calendar");window.location.href=e},disabled:p||y,className:"w-full",children:p?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.A,{className:"w-4 h-4 mr-2 animate-spin"}),"Connecting..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l.A,{className:"w-4 h-4 mr-2"}),"Connect Google Calendar"]})}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:"You'll be redirected to Google to authorize access"})]}),!A&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("div",{className:"text-xs text-muted-foreground",children:"Or enter authorization code manually:"}),(0,a.jsx)("input",{type:"text",value:v,onChange:e=>w(e.target.value),placeholder:"Enter authorization code",className:"w-full px-3 py-2 text-sm border rounded-md"}),(0,a.jsx)(s.$,{onClick:()=>D(v),disabled:!v||p,size:"sm",className:"w-full",children:"Authenticate"})]})]})]})}},62523:(e,t,o)=>{o.d(t,{p:()=>s});var a=o(95155);o(12115);var n=o(59434);function s(e){let{className:t,type:o,...s}=e;return(0,a.jsx)("input",{type:o,"data-slot":"input",className:(0,n.cn)("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",t),...s})}},87519:(e,t,o)=>{o.d(t,{R:()=>s});var a=o(12115);class n{getAuthUrl(e){let t=new URLSearchParams({client_id:this.config.clientId,redirect_uri:this.config.redirectUri,response_type:"code",scope:this.config.scopes.join(" "),access_type:"offline",prompt:"consent"});return e&&t.append("state",e),"https://accounts.google.com/o/oauth2/v2/auth?".concat(t.toString())}async handleAuthCallback(e,t){try{var o,a,n,s,c;console.log("Starting auth callback with code:",e?"present":"missing");let t=await fetch("/api/google-calendar/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e})});if(console.log("Token exchange response status:",t.status,t.statusText),!t.ok){let e=await t.text();throw console.error("Token exchange failed:",t.status,t.statusText,e),Error("Failed to exchange code for tokens: ".concat(t.status," ").concat(t.statusText))}let r=await t.json();if(console.log("Token exchange successful, received data:",{hasAccessToken:!!(null==(o=r.tokens)?void 0:o.access_token),hasRefreshToken:!!(null==(a=r.tokens)?void 0:a.refresh_token),tokenLength:null==(s=r.tokens)||null==(n=s.access_token)?void 0:n.length}),!(null==(c=r.tokens)?void 0:c.access_token))throw Error("No access token received from server");console.log("Testing received token...");let l=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:"Bearer ".concat(r.tokens.access_token)}});if(console.log("User info response status:",l.status,l.statusText),!l.ok){let e=await l.text();throw console.error("Token validation failed:",l.status,l.statusText,e),Error("Token validation failed: ".concat(l.status," ").concat(l.statusText))}let i=await l.json();console.log("User info received:",{id:i.id,email:i.email,name:i.name});let d=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#f97316"],u=d[this.accounts.size%d.length],h={id:i.id,email:i.email,name:i.name,accessToken:r.tokens.access_token,refreshToken:r.tokens.refresh_token,color:u,connectedAt:new Date().toISOString()};return console.log("Creating account:",{id:h.id,email:h.email,name:h.name}),this.accounts.set(h.id,h),this.saveAccountsToStorage(),console.log("Account saved to storage"),h}catch(e){throw console.error("Error handling auth callback:",e),e}}setTokens(e){if(0===this.accounts.size){let t={id:"default",email:"unknown@example.com",name:"Default Account",accessToken:e.access_token,refreshToken:e.refresh_token,color:"#3b82f6",connectedAt:new Date().toISOString()};this.accounts.set(t.id,t),this.saveAccountsToStorage()}}loadAccountsFromStorage(){try{let e=localStorage.getItem("googleCalendarAccounts");if(console.log("Loading accounts from storage:",e),e){let t=JSON.parse(e);console.log("Parsed accounts:",t),this.accounts.clear(),t.forEach(e=>{console.log("Loading account:",e.id,e.email,e.name),this.accounts.set(e.id,e)}),console.log("Loaded accounts:",this.accounts.size)}}catch(e){console.error("Error loading accounts from storage:",e)}}saveAccountsToStorage(){try{let e=Array.from(this.accounts.values());localStorage.setItem("googleCalendarAccounts",JSON.stringify(e))}catch(e){console.error("Error saving accounts to storage:",e)}}getAccounts(){return Array.from(this.accounts.values())}getAccount(e){return this.accounts.get(e)}removeAccount(e){this.accounts.delete(e),this.saveAccountsToStorage()}getAccessToken(e){console.log("Getting access token for account ID: ".concat(e)),console.log("Available account IDs:",Array.from(this.accounts.keys()));let t=this.accounts.get(e);return console.log("Found account:",t?{id:t.id,email:t.email,hasToken:!!t.accessToken}:null),(null==t?void 0:t.accessToken)||null}async testConnection(e){console.log("Testing API connection for account ".concat(e));let t=this.getAccessToken(e);if(!t)throw console.error("No access token found for account:",e),Error("Calendar not initialized. Please authenticate first.");console.log("Access token found, testing API call...");try{let o=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:"Bearer ".concat(t)}});if(console.log("Test connection response status:",o.status,o.statusText),!o.ok){let t=await o.text();throw console.error("Test connection failed:",o.status,o.statusText,t),401===o.status&&(console.log("Token is invalid, removing account"),this.accounts.delete(e),this.saveAccountsToStorage()),Error("Test connection failed: ".concat(o.status," ").concat(o.statusText))}let a=await o.json();return console.log("Test connection successful:",a),a}catch(e){throw console.error("Error testing connection:",e),e}}debugState(){console.log("=== Google Calendar Service Debug State ==="),console.log("Number of accounts:",this.accounts.size),console.log("Account IDs:",Array.from(this.accounts.keys())),this.accounts.forEach((e,t)=>{console.log("Account ".concat(t,":"),{email:e.email,name:e.name,hasAccessToken:!!e.accessToken,hasRefreshToken:!!e.refreshToken,connectedAt:e.connectedAt})});let e=localStorage.getItem("googleCalendarAccounts");if(console.log("Raw localStorage data:",e),e)try{let t=JSON.parse(e);console.log("Parsed localStorage data:",t)}catch(e){console.log("Failed to parse localStorage data:",e)}console.log("==========================================")}clearAllData(){console.log("Clearing all Google Calendar data"),this.accounts.clear(),localStorage.removeItem("googleCalendarAccounts"),console.log("All data cleared")}async getEvents(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"primary",o=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;console.log("Getting events for account ".concat(e,", calendar ").concat(t));let n=this.getAccessToken(e);if(!n)throw console.error("No access token found for account:",e),Error("Calendar not initialized. Please authenticate first.");try{var s;let e=new Date,c=new Date(e.getTime()-6048e5),r=new Date(e.getTime()+7776e6),l=new URLSearchParams({timeMin:o||c.toISOString(),timeMax:a||r.toISOString(),singleEvents:"true",orderBy:"startTime",maxResults:"100",showDeleted:"false"}),i="https://www.googleapis.com/calendar/v3/calendars/".concat(t,"/events?").concat(l.toString());console.log("Fetching events from URL:",i),console.log("Time range:",{timeMin:o||c.toISOString(),timeMax:a||r.toISOString()});let d=await fetch(i,{headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"}});if(console.log("Response status:",d.status,d.statusText),!d.ok){let e=await d.text();throw console.error("Failed to fetch events:",d.status,d.statusText,e),Error("Failed to fetch events: ".concat(d.status," ").concat(d.statusText))}let u=await d.json();return console.log("Full response data:",u),console.log("Received ".concat((null==(s=u.items)?void 0:s.length)||0," events from Google Calendar")),u.items&&u.items.length>0&&console.log("Sample event:",u.items[0]),u.items||[]}catch(e){throw console.error("Error fetching events:",e),e}}async listCalendars(e){console.log("Listing calendars for account ".concat(e));let t=this.getAccessToken(e);if(!t)throw console.error("No access token found for account:",e),Error("Calendar not initialized. Please authenticate first.");try{let e=await fetch("https://www.googleapis.com/calendar/v3/users/me/calendarList",{headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"}});if(console.log("Calendar list response status:",e.status,e.statusText),!e.ok){let t=await e.text();throw console.error("Failed to list calendars:",e.status,e.statusText,t),Error("Failed to list calendars: ".concat(e.status," ").concat(e.statusText))}let o=await e.json();return console.log("Available calendars:",o.items),o.items||[]}catch(e){throw console.error("Error listing calendars:",e),e}}async getAllEvents(e,t){console.log("Getting all events from accounts:",this.accounts.size);let o=[];for(let a of this.accounts.values())try{console.log("Fetching events for account: ".concat(a.email," (ID: ").concat(a.id,")")),console.log("Account details:",{id:a.id,email:a.email,hasToken:!!a.accessToken}),await this.testConnection(a.id),console.log("API connection successful for account ".concat(a.email));let n=await this.listCalendars(a.id);console.log("Found ".concat(n.length," calendars for account ").concat(a.email));let s=await this.getEvents(a.id,"primary",e,t);console.log("Found ".concat(s.length," events for account ").concat(a.email)),o.push(...s.map(e=>({...e,_accountId:a.id,_accountEmail:a.email,_accountColor:a.color})))}catch(e){console.error("Error fetching events for account ".concat(a.email,":"),e)}return console.log("Total events found: ".concat(o.length)),o}async createEvent(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"primary",a=this.getAccessToken(e);if(!a)throw Error("Calendar not initialized. Please authenticate first.");try{let e=await fetch("https://www.googleapis.com/calendar/v3/calendars/".concat(o,"/events"),{method:"POST",headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw Error("Failed to create event: ".concat(e.statusText));return await e.json()}catch(e){throw console.error("Error creating event:",e),e}}async updateEvent(e,t,o){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"primary",n=this.getAccessToken(e);if(!n)throw Error("Calendar not initialized. Please authenticate first.");try{let e=await fetch("https://www.googleapis.com/calendar/v3/calendars/".concat(a,"/events/").concat(t),{method:"PUT",headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok)throw Error("Failed to update event: ".concat(e.statusText));return await e.json()}catch(e){throw console.error("Error updating event:",e),e}}async deleteEvent(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"primary",a=this.getAccessToken(e);if(!a)throw Error("Calendar not initialized. Please authenticate first.");try{let e=await fetch("https://www.googleapis.com/calendar/v3/calendars/".concat(o,"/events/").concat(t),{method:"DELETE",headers:{Authorization:"Bearer ".concat(a)}});if(!e.ok)throw Error("Failed to delete event: ".concat(e.statusText));return!0}catch(e){throw console.error("Error deleting event:",e),e}}convertToGoogleEvent(e){var t;return{summary:e.title,description:e.description||"",start:{dateTime:e.start,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},end:{dateTime:e.end,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},location:e.location||"",attendees:(null==(t=e.attendees)?void 0:t.map(e=>({email:e.email,displayName:e.name})))||[],reminders:{useDefault:!0}}}convertFromGoogleEvent(e){var t;return{id:e.id,title:e.summary,start:e.start.dateTime||e.start.date,end:e.end.dateTime||e.end.date,description:e.description,location:e.location,attendees:(null==(t=e.attendees)?void 0:t.map(e=>({email:e.email,name:e.displayName||e.email})))||[],googleEventId:e.id,accountId:e._accountId,accountEmail:e._accountEmail,accountColor:e._accountColor}}constructor(e){this.accounts=new Map,this.config={...e,scopes:["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/calendar.events","https://www.googleapis.com/auth/calendar.readonly"]}}}function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{autoSync:t=!1,syncInterval:o=3e5}=e,[s,c]=(0,a.useState)({isAuthenticated:!1,isLoading:!1,error:null,events:[],accounts:[]}),[r]=(0,a.useState)(()=>new n({clientId:"1017424324791-093h4v94cd9l2vu9cvtdindum5p9e82b.apps.googleusercontent.com",redirectUri:"http://localhost:3000/api/google-calendar/auth/callback",scopes:["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/calendar.events","https://www.googleapis.com/auth/calendar.readonly"]}));(0,a.useEffect)(()=>{r.loadAccountsFromStorage();let e=r.getAccounts(),t=e.length>0;c(o=>({...o,isAuthenticated:t,accounts:e}))},[r]),(0,a.useEffect)(()=>{s.isAuthenticated&&t&&setTimeout(()=>{r.getAllEvents().then(e=>{c(t=>({...t,events:e}))}).catch(e=>{console.error("Error fetching events:",e),c(e=>({...e,error:"Failed to fetch events"}))})},100)},[s.isAuthenticated,t,r]),(0,a.useEffect)(()=>{if(!t||!s.isAuthenticated)return;let e=async()=>{try{let e=await r.getAllEvents();c(t=>({...t,events:e}))}catch(e){console.error("Auto-sync error:",e),c(e=>({...e,error:"Auto-sync failed"}))}};e();let a=setInterval(e,o);return()=>clearInterval(a)},[t,s.isAuthenticated,o,r]);let l=(0,a.useCallback)(e=>r.getAuthUrl(e),[r]),i=(0,a.useCallback)(async(e,t)=>{c(e=>({...e,isLoading:!0,error:null}));try{let o=await r.handleAuthCallback(e,t),a=r.getAccounts();return c(e=>({...e,isAuthenticated:a.length>0,accounts:a,isLoading:!1})),o}catch(e){throw console.error("Authentication error:",e),c(e=>({...e,error:"Authentication failed",isLoading:!1})),e}},[r]),d=(0,a.useCallback)(async(e,t)=>{if(!s.isAuthenticated)return console.log("Not authenticated, skipping event fetch"),[];c(e=>({...e,isLoading:!0,error:null}));try{console.log("Fetching events from Google Calendar...");let o=await r.getAllEvents(e,t);return console.log("Fetched events from Google Calendar:",o),console.log("Number of events fetched:",o.length),o.length>0&&console.log("Sample event structure:",o[0]),c(e=>({...e,events:o,isLoading:!1})),o}catch(e){throw console.error("Error fetching events:",e),c(e=>({...e,error:"Failed to fetch events",isLoading:!1})),e}},[s.isAuthenticated,r]),u=(0,a.useCallback)(async(e,t)=>{if(!s.isAuthenticated)throw Error("Not authenticated with Google Calendar");c(e=>({...e,isLoading:!0,error:null}));try{let o=await r.createEvent(e,t);return c(e=>({...e,events:[...e.events,o],isLoading:!1})),o}catch(e){throw console.error("Error creating event:",e),c(e=>({...e,error:"Failed to create event",isLoading:!1})),e}},[s.isAuthenticated,r]),h=(0,a.useCallback)(async(e,t,o)=>{if(!s.isAuthenticated)throw Error("Not authenticated with Google Calendar");c(e=>({...e,isLoading:!0,error:null}));try{let a=await r.updateEvent(e,t,o);return c(e=>({...e,events:e.events.map(e=>e.id===t?a:e),isLoading:!1})),a}catch(e){throw console.error("Error updating event:",e),c(e=>({...e,error:"Failed to update event",isLoading:!1})),e}},[s.isAuthenticated,r]),g=(0,a.useCallback)(async(e,t)=>{if(!s.isAuthenticated)throw Error("Not authenticated with Google Calendar");c(e=>({...e,isLoading:!0,error:null}));try{return await r.deleteEvent(e,t),c(e=>({...e,events:e.events.filter(e=>e.id!==t),isLoading:!1})),!0}catch(e){throw console.error("Error deleting event:",e),c(e=>({...e,error:"Failed to delete event",isLoading:!1})),e}},[s.isAuthenticated,r]),m=(0,a.useCallback)(e=>{r.removeAccount(e);let t=r.getAccounts();c(e=>({...e,isAuthenticated:t.length>0,accounts:t}))},[r]),f=(0,a.useCallback)(()=>{localStorage.removeItem("googleCalendarAccounts"),c({isAuthenticated:!1,isLoading:!1,error:null,events:[],accounts:[]})},[]),v=(0,a.useCallback)(e=>r.convertToGoogleEvent(e),[r]),w=(0,a.useCallback)(e=>r.convertFromGoogleEvent(e),[r]);return{isAuthenticated:s.isAuthenticated,isLoading:s.isLoading,error:s.error,events:s.events,accounts:s.accounts,getAuthUrl:l,handleAuthCallback:i,fetchEvents:d,createEvent:u,updateEvent:h,deleteEvent:g,removeAccount:m,logout:f,convertToGoogleEvent:v,convertFromGoogleEvent:w,debugState:()=>r.debugState(),clearAllData:()=>r.clearAllData()}}}}]);